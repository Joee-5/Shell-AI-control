import rclpy
from rclpy.node import Node
from nav_msgs.msg import Path
from geometry_msgs.msg import PoseStamped
import numpy as np

# Combined TRACK_POINTS: Original data + Full Return Leg
TRACK_POINTS = np.array([
    [-4.558597, 0.061121], [-2.401001, 0.042202], [0.940216, -0.007674],
    [5.217319, -0.078189], [10.182570, -0.159023], [15.588230, -0.239857],
    [21.186570, -0.310372], [26.729850, -0.360249], [31.970330, -0.379167],
    [36.660270, -0.356809], [40.551940, -0.282854], [43.397610, -0.146984],
    [44.949540, 0.061121], [48.371120, 1.775234], [50.573340, 4.342968],
    [51.790450, 7.614625], [52.256690, 11.440510], [52.206320, 15.670930],
    [51.873580, 20.156180], [51.492710, 24.746570], [51.297960, 29.292400],
    [51.523590, 33.643980], [52.403840, 37.651620], [54.172950, 41.165610],
    [57.065190, 44.036260], [58.588940, 45.150300], [60.219150, 46.463640],
    [61.849460, 47.979430], [63.373530, 49.700790], [64.684990, 51.630850],
    [65.677500, 53.772740], [66.244700, 56.129590], [66.280230, 58.704530],
    [65.677740, 61.500680], [64.330880, 64.521180], [62.133290, 67.769160],
    [58.978620, 71.247740], [58.105520, 72.017050], [57.020180, 72.847820],
    [55.766970, 73.735570], [54.390240, 74.675800], [52.934360, 75.664020],
    [51.443690, 76.695730], [49.962600, 77.766460], [48.535430, 78.871700],
    [47.206560, 80.006970], [46.020350, 81.167770], [45.021150, 82.349600],
    [44.253330, 83.547990], [42.907030, 87.279320], [42.668370, 91.006780],
    [43.314670, 94.730510], [44.623250, 98.450680], [46.371440, 102.167400],
    [48.336570, 105.880900], [50.295950, 109.591300], [52.026910, 113.298700],
    [53.306780, 117.003400], [53.912870, 120.705400], [53.622530, 124.404900],
    [52.213060, 128.102000], [48.753910, 131.925400], [43.325930, 134.934000],
    [36.315110, 137.167000], [28.107460, 138.663700], [19.088980, 139.463300],
    [9.645670, 139.605100], [0.163531, 139.128300], [-8.971436, 138.072100],
    [-17.373230, 136.475700], [-24.655850, 134.378500], [-30.433300, 131.819600],
    [-34.319550, 128.838200], [-35.354930, 127.758600], [-36.603500, 126.550800],
    [-38.003830, 125.180900], [-39.494450, 123.614800], [-41.013910, 121.818600],
    [-42.500770, 119.758100], [-43.893570, 117.399300], [-45.130860, 114.708300],
    [-46.151190, 111.650900], [-46.893100, 108.193200], [-47.295150, 104.301000],
    [-47.295890, 99.940460], [-47.208960, 97.567750], [-47.152200, 94.814460],
    [-47.121310, 91.741730], [-47.111970, 88.410750], [-47.119870, 84.882650],
    [-47.140710, 81.218620], [-47.170160, 77.479810], [-47.203930, 73.727380],
    [-47.237700, 70.022490], [-47.267160, 66.426320], [-47.287990, 63.000000],
    [-47.295890, 59.804710], [-47.295890, 52.373600],
    # --- RETURN LEG ADDED BELOW ---
    [-46.987900, 20.854450], [-46.121770, 14.716410],
    [-44.784220, 9.883191], [-43.062000, 6.203030], [-41.041830, 3.524173],
    [-38.810450, 1.694863], [-36.454600, 0.563344], [-34.061010, -0.022142],
    [-31.716420, -0.213351], [-29.507560, -0.162040], [-27.521170, -0.019965],
    [-25.843980, 0.061121], [-23.584080, 0.061121], [-21.374230, 0.061121],
    [-19.225930, 0.061121], [-17.150680, 0.061121], [-15.159980, 0.061121],
    [-13.265340, 0.061121], [-11.478250, 0.061121], [-9.810216, 0.061121],
    [-8.272733, 0.061121], [-6.877303, 0.061121], [-5.635426, 0.061121],
      # Loop Closure
])

class FullPathNode(Node):
    def __init__(self):
        super().__init__('path_node')
        self.path_pub = self.create_publisher(Path, '/path', 10)
        self.path_msg = Path()
        self.path_msg.header.frame_id = "map" # Essential for RViz Fixed Frame
        
        # NOTE: Generates the path using all provided set points
        self.generate_full_path()
        
        self.timer = self.create_timer(1.0, self.publish_path)
        self.get_logger().info("âœ… Complete Circuit Path Node Started")

    def generate_full_path(self):
        # Publishes every coordinate point in the array as a waypoint
        for pt in TRACK_POINTS:
            pose = PoseStamped()
            pose.header.frame_id = "map"
            pose.pose.position.x = float(pt[0])
            pose.pose.position.y = float(pt[1])
            pose.pose.position.z = 0.5 # Maintain Z-lift for visibility
            self.path_msg.poses.append(pose)

    def publish_path(self):
        # Update timestamp and publish the complete array
        self.path_msg.header.stamp = self.get_clock().now().to_msg()
        self.path_pub.publish(self.path_msg)

def main(args=None):
    rclpy.init(args=args)
    node = FullPathNode()
    try:
        rclpy.spin(node)
    except KeyboardInterrupt:
        pass
    node.destroy_node()
    rclpy.shutdown()